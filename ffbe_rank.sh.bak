#!/bin/bash
case=$2
run=$1
reboot_timing=6
folder="/home/ncho/Projects/upload/FFBE"
date=`date +%Y%m%d`
time=`date +%H%M`
log_file="$folder/$date/$time/debug.log"
echo "$folder"
echo "$date"
echo "$time"

function reset_device_overnight(){
    echo reset_device $1 |tee -a $log_file
    /home/ncho/bin/adb -s CB512168CU shell input keyevent 3 ## home key
    sleep 5
    #echo "home" |tee -a $log_file
    /home/ncho/bin/adb -s CB512168CU shell am force-stop com.square_enix.android_googleplay.FFBEWW
    echo "kill FFBE" |tee -a $log_file
    sleep 10
    /home/ncho/bin/adb -s CB512168CU shell input tap 100 792 ## app icon
    echo "app icon" |tee -a $log_file
    sleep 50
    echo "reset_device_overnight !!`date +%Y%m%d:%H%M:%S`" |tee -a $log_file
    /home/ncho/bin/adb -s CB512168CU shell input tap 100 792 ## touch for input.
    sleep 130
    /home/ncho/bin/adb -s CB512168CU shell input tap 100 770 ## to cancel the ask.
    #echo "to cancel the ask" |tee -a $log_file
    sleep 10
}

function reset_device(){
    echo reset_device $1 |tee -a $log_file
    /home/ncho/bin/adb -s CB512168CU shell input keyevent 3 ## home key
    sleep 3
    #echo "home" |tee -a $log_file
    /home/ncho/bin/adb -s CB512168CU shell am force-stop com.square_enix.android_googleplay.FFBEWW
    echo "kill FFBE" |tee -a $log_file
    sleep 5
    /home/ncho/bin/adb -s CB512168CU shell input tap 100 792 ## app icon
    echo "app icon" |tee -a $log_file
    sleep 50
    /home/ncho/bin/adb -s CB512168CU shell input tap 100 792 ## touch for input.
    #echo "touch first input" |tee -a $log_file
    sleep 70
    /home/ncho/bin/adb -s CB512168CU shell input tap 100 770 ## to cancel the ask.
    #echo "to cancel the ask" |tee -a $log_file
    sleep 10
}


function setup_trust_overnight(){
    /home/ncho/bin/adb -s CB512168CU shell input tap 365 953 #world
    sleep 15
    /home/ncho/bin/adb -s CB512168CU shell input tap 690 630 # slect1
    sleep 15
    /home/ncho/bin/adb -s CB512168CU shell input tap 489 533 # select 2
    sleep 14
    /home/ncho/bin/adb -s CB512168CU shell input swipe 345 953 754 953 #  move to action 1
    sleep 20
    /home/ncho/bin/adb -s CB512168CU shell input tap 513 897 # action 1
    sleep 15
    echo "setup_trust_overnight `date +%Y%m%d:%H%M:%S` $1" |tee -a $log_file
}

function setup_trust(){
    /home/ncho/bin/adb -s CB512168CU shell input tap 365 953 #world
    #echo "world" |tee -a $log_file
    sleep 10
    /home/ncho/bin/adb -s CB512168CU shell input tap 690 630 # first 
    #echo "select 1" |tee -a $log_file
    sleep 10
    /home/ncho/bin/adb -s CB512168CU shell input tap 489 533 # select 2
    #echo "select 2" |tee -a $log_file
    sleep 7
    /home/ncho/bin/adb -s CB512168CU shell input swipe 345 953 754 953 #  move to action 1
    #echo "move to action 1" |tee -a $log_file
    sleep 7
    /home/ncho/bin/adb -s CB512168CU shell input tap 513 897 # action 1
    #echo "action 1" |tee -a $log_file
    sleep 7
    echo "`date +%Y%m%d:%H%M:%S` $1" |tee -a $log_file
}

function setup_map(){
    /home/ncho/bin/adb -s CB512168CU shell input tap 365 953 #world
    sleep 5
    /home/ncho/bin/adb -s CB512168CU shell input tap 342 431 # slect1
    sleep 5
    /home/ncho/bin/adb -s CB512168CU shell input tap 489 533 # select 2
    sleep 5
    /home/ncho/bin/adb -s CB512168CU shell input swipe 500 953 200 500
    sleep 5
    /home/ncho/bin/adb -s CB512168CU shell input tap 450 1000 #
    sleep 5
}

if [ "$#" -lt 2 ]; then
    echo "command: /home/ncho/bin/ffbe_rank.sh <run> <acro_120/overnight/overnight_debug/4pm>"
else
    if [ "$case" == "4pm" ]; then
	mkdir -p $folder/$date/$time
        cd $folder/$date/$time
	echo "`date +%Y%m%d:%H%M:%S` $1" |tee -a $log_file
	reset_device "first_initial"
	reset_device "4pm_items"
	echo "4pm_items" |tee -a $log_file
        /home/ncho/bin/adb -s CB512168CU shell input tap 640 900 # make item
	echo "make item" |tee -a $log_file
        sleep 5
	/home/ncho/bin/adb -s CB512168CU shell input tap 640 380 # Props
        echo "slect Props" |tee -a $log_file
	sleep 5
        /home/ncho/bin/adb -s CB512168CU shell input tap 300 510 # first item
	echo "first item" |tee -a $log_file
        sleep 5
        /home/ncho/bin/adb -s CB512168CU shell input tap 300 860 # get first item
	echo "get first item" |tee -a $log_file
        sleep 5
        reset_device "4pm_items"
	/home/ncho/bin/adb -s CB512168CU shell input tap 640 900 # make item
        echo "make item" |tee -a $log_file
        sleep 5
        /home/ncho/bin/adb -s CB512168CU shell input tap 640 380 # Props
        echo "slect Props" |tee -a $log_file
        sleep 5
        /home/ncho/bin/adb -s CB512168CU shell input tap 300 510 # first item
	echo "first item" |tee -a $log_file
        sleep 5
	/home/ncho/bin/adb -s CB512168CU shell input tap 500 400 # ATT
	echo "ATT item" |tee -a $log_file
	sleep 5
        /home/ncho/bin/adb -s CB512168CU shell input tap 300 660 # make 2rd itmes
	echo "make 2rd item" |tee -a $log_file
        sleep 5
        /home/ncho/bin/adb -s CB512168CU shell input tap 470 940 # make
	echo "make" |tee -a $log_file
        sleep 5
        /home/ncho/bin/adb -s CB512168CU shell input tap 470 720 # yes for make
	echo "yes for make" |tee -a $log_file
        sleep 10
	echo "`date +%Y%m%d:%H%M:%S` $1" |tee -a $log_file
	## ====================================================================
	reset_device "4pm_trust"
	setup_trust "4pm"
	for ((i=0; i<${run}; i=i+1))
	do
	    echo "4pm_trust %i" |tee -a $log_file
            /home/ncho/bin/adb -s CB512168CU shell input tap 423 645
            #echo "slect game 1" |tee -a $log_file
            sleep 5
            /home/ncho/bin/adb -s CB512168CU shell input tap 372 1124
            #echo "step 2" |tee -a $log_file
            sleep 5
            /home/ncho/bin/adb -s CB512168CU shell input tap 456 432
            #echo "slect team" |tee -a $log_file
            sleep 5
            /home/ncho/bin/adb -s CB512168CU shell input tap 397 1084 # game start
            #echo "game start" |tee -a $log_file
            sleep 40
            /home/ncho/bin/adb -s CB512168CU shell input tap 104 1238 # auto
            #echo "auto" |tee -a $log_file
            sleep 90
            /home/ncho/bin/adb -s CB512168CU shell input tap 350 1100
            sleep 10
            /home/ncho/bin/adb -s CB512168CU shell input tap 350 1100
            #echo "next2" |tee -a $log_file
            sleep 10
            /home/ncho/bin/adb -s CB512168CU shell input tap 350 1100
            #echo "next3" |tee -a $log_file
            sleep 10
	done
	echo "`date +%Y%m%d:%H%M:%S` $1" |tee -a $log_file
        ##=================================
	reset_device "4pm_friend"
        /home/ncho/bin/adb -s CB512168CU shell input tap 660 1210 # friend
        echo "friend" |tee -a $log_file
        sleep 5
	/home/ncho/bin/adb -s CB512168CU shell input tap 570 610 #gift
	echo "gift" |tee -a $log_file
	sleep 5
        /home/ncho/bin/adb -s CB512168CU shell input tap 610 270 # sent
        echo "sent" |tee -a $log_file
        sleep 5
        /home/ncho/bin/adb -s CB512168CU shell input tap 410 300 # all sent
        echo "all sent" |tee -a $log_file
        sleep 5
        /home/ncho/bin/adb -s CB512168CU shell input tap 610 270 # receiver
        echo "receiver" |tee -a $log_file
        sleep 5
        /home/ncho/bin/adb -s CB512168CU shell input tap 410 300 # all receiver
	echo "all receiver" |tee -a $log_file
        sleep 5
        /home/ncho/bin/adb -s CB512168CU shell input tap 40 300 # back
	echo "back" |tee -a $log_file
        sleep 10
	/home/ncho/bin/adb -s CB512168CU shell input keyevent 3
	echo "`date +%Y%m%d:%H%M:%S` $1" |tee -a $log_file
    elif [ "$case" == "acro_7mins" ]; then
        mkdir -p $folder/$date/$time
        cd $folder/$date/$time
        reset_device 0
	setup_trust 0
        for ((i=0; i<=${run}; i=i+1))
        do
            echo "run $i"
            echo "run $i" |tee -a $log_file
	    /home/ncho/bin/adb -s CB512168CU shell input tap 423 645
            echo "slect game 1" |tee -a $log_file
            sleep 10
            /home/ncho/bin/adb -s CB512168CU shell input tap 372 1124
            echo "step 2" |tee -a $log_file
            sleep 10
            /home/ncho/bin/adb -s CB512168CU shell input tap 456 432
            echo "slect team" |tee -a $log_file
            sleep 10
            /home/ncho/bin/adb -s CB512168CU shell input tap 397 1084 # game start
            echo "game start" |tee -a $log_file
            sleep 100
            /home/ncho/bin/adb -s CB512168CU shell input tap 104 1238 # auto
            echo "auto" |tee -a $log_file
            sleep 110
            /home/ncho/bin/adb -s CB512168CU shell input tap 350 1100
            echo "next1" |tee -a $log_file
            sleep 130
            /home/ncho/bin/adb -s CB512168CU shell input tap 350 1100
            echo "next2" |tee -a $log_file
            sleep 10
            /home/ncho/bin/adb -s CB512168CU shell input tap 350 1100
            echo "next3" |tee -a $log_file
            sleep 30
        done
    elif [ "$case" == "overnight_debug" ]; then
        mkdir -p $folder/$date/$time
        cd $folder/$date/$time
        /home/ncho/bin/adb -s CB512168CU shell input keyevent 3
        sleep 2
        /home/ncho/bin/adb -s CB512168CU shell screencap -p /sdcard/screen_start.png
        /home/ncho/bin/adb -s CB512168CU pull /sdcard/screen_start.png
        /home/ncho/bin/adb -s CB512168CU shell rm /sdcard/screen_start.png
        for ((i=0; i<=${run}; i=i+1))
        do
            j=$(( $i % $reboot_timing ))
            echo $j
            if [ $j == "0" ]; then
                     reset_device $i
                     setup_trust $i
            fi
            echo "run $i  `date +%Y%m%d:%H%M:%S`" |tee -a $log_file
            /home/ncho/bin/adb -s CB512168CU shell input tap 423 645
            echo "slect game 1" |tee -a $log_file
            sleep 5
            /home/ncho/bin/adb -s CB512168CU shell input tap 372 1124
            echo "step 2" |tee -a $log_file
            sleep 5
            /home/ncho/bin/adb -s CB512168CU shell input tap 456 432
            echo "slect team" |tee -a $log_file
            sleep 5
            /home/ncho/bin/adb -s CB512168CU shell input tap 397 1084 # game start
            echo "game start" |tee -a $log_file
            sleep 20
            /home/ncho/bin/adb -s CB512168CU shell input tap 104 1238 # auto
            echo "auto" |tee -a $log_file
            sleep 70
            /home/ncho/bin/adb -s CB512168CU shell input tap 350 1100
            echo "next1" |tee -a $log_file
            #if [ "$i" == "0" ] || [ "$i" -gt "$(($run-5))" ]; then
              echo "Nor debug screen_${i}.png" | tee -a $log_file
              sleep 5
              /home/ncho/bin/adb -s CB512168CU shell screencap -p /sdcard/screen_${i}.png
              /home/ncho/bin/adb -s CB512168CU pull /sdcard/screen_${i}.png
              /home/ncho/bin/adb -s CB512168CU shell rm /sdcard/screen_${i}.png
              sleep 5
            #else
            #  sleep 11
            #fi
            /home/ncho/bin/adb -s CB512168CU shell input tap 350 1100
            echo "next2" |tee -a $log_file
            sleep 5
            /home/ncho/bin/adb -s CB512168CU shell input tap 350 1100
            echo "next3" |tee -a $log_file
            sleep 10
        done
        /home/ncho/bin/adb -s CB512168CU shell input keyevent 3 # go to home for charge.
        sleep 3
        /home/ncho/bin/adb -s CB512168CU shell am force-stop com.square_enix.android_googleplay.FFBEWW
        sleep 3
        /home/ncho/bin/adb -s CB512168CU shell screencap -p /sdcard/screen_end.png
        /home/ncho/bin/adb -s CB512168CU pull /sdcard/screen_end.png
        /home/ncho/bin/adb -s CB512168CU shell rm /sdcard/screen_end.png

    elif [ "$case" == "overnight" ]; then
        mkdir -p $folder/$date/$time
        cd $folder/$date/$time
	/home/ncho/bin/adb -s CB512168CU shell input keyevent 3
	sleep 2
        /home/ncho/bin/adb -s CB512168CU shell screencap -p /sdcard/screen_start.png
        /home/ncho/bin/adb -s CB512168CU pull /sdcard/screen_start.png
        /home/ncho/bin/adb -s CB512168CU shell rm /sdcard/screen_start.png
        for ((i=0; i<=${run}; i=i+1))
        do
            j=$(( $i % $reboot_timing ))
            echo $j
            if [ $j == "0" ]; then
                     reset_device_overnight $i
		     setup_trust_overnight $i
            fi
            echo "run $i  `date +%Y%m%d:%H%M:%S`" |tee -a $log_file
            /home/ncho/bin/adb -s CB512168CU shell input tap 423 645
	    #echo "slect game 1" |tee -a $log_file
            sleep 10
            /home/ncho/bin/adb -s CB512168CU shell input tap 372 1124
	    #echo "step 2" |tee -a $log_file
            sleep 10
            /home/ncho/bin/adb -s CB512168CU shell input tap 456 432
	    #echo "slect team" |tee -a $log_file
            sleep 10
            /home/ncho/bin/adb -s CB512168CU shell input tap 397 1084 # game start
	    #echo "game start" |tee -a $log_file
            sleep 60
            /home/ncho/bin/adb -s CB512168CU shell input tap 104 1238 # auto
            #echo "auto" |tee -a $log_file
            sleep 110
            /home/ncho/bin/adb -s CB512168CU shell input tap 350 1100
	    #echo "next1" |tee -a $log_file
	    #if [ "$i" == "0" ] || [ "$i" -gt "$(($run-5))" ]; then
	      echo "Nor debug screen_${i}.png" | tee -a $log_file
	      sleep 5
	      /home/ncho/bin/adb -s CB512168CU shell screencap -p /sdcard/screen_${i}.png
              /home/ncho/bin/adb -s CB512168CU pull /sdcard/screen_${i}.png
              /home/ncho/bin/adb -s CB512168CU shell rm /sdcard/screen_${i}.png
	      sleep 5
	    #else
            #  sleep 11
            #fi
            /home/ncho/bin/adb -s CB512168CU shell input tap 350 1100
	    #echo "next2" |tee -a $log_file
            sleep 10
            /home/ncho/bin/adb -s CB512168CU shell input tap 350 1100
            #echo "next3" |tee -a $log_file
            sleep 25
        done
	/home/ncho/bin/adb -s CB512168CU shell input keyevent 3 # go to home for charge.
	sleep 3
	/home/ncho/bin/adb -s CB512168CU shell am force-stop com.square_enix.android_googleplay.FFBEWW
	sleep 3
	/home/ncho/bin/adb -s CB512168CU shell screencap -p /sdcard/screen_end.png
        /home/ncho/bin/adb -s CB512168CU pull /sdcard/screen_end.png
        /home/ncho/bin/adb -s CB512168CU shell rm /sdcard/screen_end.png
    elif [ "$case" == "acro_120" ]; then
        echo "acro_120"
        mkdir -p $folder/$date/$time
        cd $folder/$date/$time
        reset_device 0
	setup_trust 0
        for ((i=0; i<=${run}; i=i+1))
        do
            echo "run $i `date +%Y%m%d:%H%M:%S`" |tee -a $log_file
            /home/ncho/bin/adb -s CB512168CU shell input tap 423 645
            echo "slect game 1" |tee -a $log_file
            sleep 5
            /home/ncho/bin/adb -s CB512168CU shell input tap 372 1124
            echo "step 2" |tee -a $log_file
            sleep 5
            /home/ncho/bin/adb -s CB512168CU shell input tap 456 432
            echo "slect team" |tee -a $log_file
            sleep 5
            /home/ncho/bin/adb -s CB512168CU shell input tap 397 1084 # game start
            echo "game start" |tee -a $log_file
            sleep 20
            /home/ncho/bin/adb -s CB512168CU shell input tap 104 1238 # auto
            echo "auto" |tee -a $log_file
            sleep 60
            /home/ncho/bin/adb -s CB512168CU shell input tap 350 1100
            echo "next1" |tee -a $log_file
            sleep 5
            /home/ncho/bin/adb -s CB512168CU shell input tap 350 1100
            echo "next2" |tee -a $log_file
            sleep 5
            /home/ncho/bin/adb -s CB512168CU shell input tap 350 1100
            echo "next3" |tee -a $log_file
            sleep 10
        done
     elif [ "$case" == "reset_device" ]; then
        mkdir -p $folder/$date/$time
        cd $folder/$date/$time
        reset_device "test" |tee -a $log_file
	setup_trust "test"
    else
        echo "$case don't support" |tee -a $log_file
    fi
       echo "Task finish" |tee -a $log_file
fi
exit 0
